<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TTA — Speed × Frequent Flyer Reports</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#0f1115; --panel:#151924; --ink:#f2f5f9; --muted:#aab3c5;
      --accent:#7bd389; --accent2:#a7c5ff; --danger:#ff9aa2; --warn:#ffe29a;
      --line:#262c3a; --code:#0b0e13; --chip:#1d2330; --link:#b5c7ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--ink); font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
    }
    header{
      padding:28px 20px; background:linear-gradient(135deg,#1b2240 0%,#15223a 60%,#111a2d 100%);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1000px; margin:0 auto; padding:0 16px}
    h1{font-size:26px; margin:0 0 6px}
    .sub{color:var(--muted); font-size:14px}
    nav{margin-top:14px; display:flex; flex-wrap:wrap; gap:8px}
    .chip{
      display:inline-block; padding:8px 12px; border:1px solid var(--line); border-radius:999px;
      background:var(--chip); color:var(--ink); text-decoration:none; font-weight:600; font-size:14px;
    }
    main{padding:26px 0}
    section{background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:18px; margin:0 0 16px}
    h2{font-size:20px; margin:0 0 10px}
    p{margin:10px 0}
    code, pre{background:var(--code); color:var(--ink); border:1px solid var(--line); border-radius:8px}
    code{padding:2px 6px}
    pre{padding:12px; overflow:auto}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .btn{
      display:inline-block; padding:10px 14px; border-radius:10px; border:1px solid var(--line);
      background:#1d2638; color:var(--ink); text-decoration:none; font-weight:700;
    }
    .btn.secondary{background:#1a2231}
    .btnbar{display:flex; gap:10px; flex-wrap:wrap}
    ul{margin:8px 0 8px 18px}
    li{margin:4px 0}
    .kv{display:grid; grid-template-columns:200px 1fr; gap:8px}
    .pill{display:inline-block; padding:3px 8px; border-radius:999px; border:1px solid var(--line); background:var(--chip); font-weight:700; font-size:12px}
    .ok{background:#163224; color:#9ae6b4}
    .warn{background:#2d2a12; color:#ffe29a}
    .bad{background:#3a1a1e; color:#ff9aa2}
    .muted{color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    details{border:1px dashed var(--line); border-radius:10px; padding:10px 12px}
    summary{cursor:pointer; font-weight:700}
    footer{padding:20px; color:var(--muted); text-align:center}
    a{color:var(--link)}
    @media (max-width:820px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Speed × Frequent Flyer — In-Store</h1>
      <div class="sub">Fast view of budtender performance combining transaction speed and Frequent Flyer acquisitions. Delivery &amp; “TTA Non Stop” are excluded; In-Store preferred.</div>
      <nav>
        <a class="chip" href="./README.md">README</a>
        <a class="chip" href="./config/exclusions.json">Ex-Staff Config</a>
        <a class="chip" href="./.github/workflows/generate.yml">Workflow</a>
        <a class="chip" href="#run">Run Reports</a>
        <a class="chip" href="#outputs">Outputs</a>
        <a class="chip" href="#faq">FAQ</a>
      </nav>
    </div>
  </header>

  <main class="wrap">

    <section id="status">
      <h2>Quick Status</h2>
      <div class="grid">
        <div>
          <p><strong>Ex-staff loaded:</strong> <span id="exCount" class="pill muted">checking…</span></p>
          <p class="muted">Preview from <code>config/exclusions.json</code>:</p>
          <ul id="exList" class="muted"></ul>
        </div>
        <div>
          <p><strong>One-sheets present in <code>/out</code>:</strong></p>
          <ul>
            <li>Overall: <span id="chkOverall" class="pill muted">checking…</span> — <a id="lnkOverall" href="./out/one_sheet_overall.html">open</a></li>
            <li>Peak 3–7pm: <span id="chkPeak" class="pill muted">checking…</span> — <a id="lnkPeak" href="./out/one_sheet_peak.html">open</a></li>
          </ul>
          <p class="muted">If these show as “missing”, run the workflow and download artifacts; or commit the generated HTML to <code>/out</code> if you want them to render on GitHub Pages.</p>
        </div>
      </div>
    </section>

    <section id="upload">
      <h2>Upload Your Data</h2>
      <ul>
        <li><strong>Transaction time CSV</strong> → <code>data/Patient Transaction Time Report.csv</code></li>
        <li><strong>Frequent Flyer files</strong> → <code>data/Fee _ Donation Transactions *.xlsx</code> (all periods)</li>
      </ul>
      <p class="muted">Filters: excludes <em>Delivery</em> and any order with “TTA Non Stop” in OrderSource/OrderType/OrderMethod; prefers In-Store if present.</p>
    </section>

    <section id="run">
      <h2>Run Reports</h2>
      <div class="grid">
        <div>
          <h3>GitHub Actions (no local setup)</h3>
          <ol>
            <li>Commit your files to <code>/data</code>.</li>
            <li>Open <strong>Actions → “Generate Speed × FF Reports”</strong> and hit <strong>Run workflow</strong>.</li>
            <li>Download artifact <strong>speed-ff-reports</strong>.</li>
          </ol>
          <p class="muted">Artifacts include: Excel workbook + one-sheets. Commit the HTML into <code>/out</code> if you want this page to link to them live.</p>
        </div>
        <div>
          <h3>Local (CLI)</h3>
          <p class="muted">From the repo root:</p>
          <pre class="mono"><code>python -m venv .venv && source .venv/bin/activate
pip install -r requirements.txt
python scripts/generate.py \n  --tx "data/Patient Transaction Time Report.csv" \n  --fee-glob "data/Fee_*Transactions*.xlsx" \n  --exclusions config/exclusions.json \n  --peak-hours "15,16,17,18,19" \n  --out out</code></pre>
        </div>
      </div>
      <details style="margin-top:10px">
        <summary>What the generator does</summary>
        <ul>
          <li>Targets ≤ <code>1:30</code> speed; eligible if ≥ <code>30</code> txns.</li>
          <li>Builds Speed tier (Green/Yellow/Red/Gray) + FF tier (High/Mid/Low) by team quartiles.</li>
          <li>Creates coaching notes based on the Speed × FF combination.</li>
          <li>Also outputs Peak Hours (3–7pm) and conversion rates.</li>
        </ul>
      </details>
    </section>

    <section id="outputs">
      <h2>Outputs</h2>
      <div class="kv">
        <div>Excel (artifact)</div>
        <div><code>out/speed_x_ff_with_peak_and_conversion.xlsx</code></div>
        <div>One-sheet (Overall)</div>
        <div><a href="./out/one_sheet_overall.html">out/one_sheet_overall.html</a></div>
        <div>One-sheet (Peak 3–7pm)</div>
        <div><a href="./out/one_sheet_peak.html">out/one_sheet_peak.html</a></div>
      </div>
      <p class="muted">These files are produced by the workflow / local script. If you enable GitHub Pages, commit the HTML into <code>/out</code> so links render publicly.</p>
    </section>

    <section id="faq">
      <h2>FAQ</h2>
      <p><strong>How do I change ex-staff?</strong> Edit <code>config/exclusions.json</code>. Re-run the workflow.</p>
      <p><strong>Change peak hours?</strong> In Actions “Run workflow”, set <code>peak_hours</code>. Locally, pass <code>--peak-hours</code>.</p>
      <p><strong>What gets filtered out?</strong> Delivery + any order with “TTA Non Stop” in OrderSource/OrderType/OrderMethod. If In-Store exists, only In-Store is used.</p>
    </section>

  </main>

  <footer>
    Speed × Frequent Flyer &middot; Built for TTA Ops &middot; <span class="muted">by Kaleo’s data pipeline</span>
  </footer>

  <script>
    // live preview of exclusions + link health for one-sheets
    async function loadExclusions(){
      const elCount = document.getElementById('exCount');
      const elList  = document.getElementById('exList');
      try{
        const res = await fetch('./config/exclusions.json', {cache:'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        const former = Array.isArray(data.former_staff) ? data.former_staff : [];
        elCount.textContent = former.length + ' names';
        elCount.className = 'pill ok';
        elList.innerHTML = former.map(n => `<li>${n}</li>`).join('') || '<li><em>None</em></li>';
        elList.classList.remove('muted');
      }catch(e){
        elCount.textContent = 'missing';
        elCount.className = 'pill bad';
        elList.innerHTML = '<li><em>Could not read config/exclusions.json</em></li>';
      }
    }

    async function checkFile(url, pillId){
      const el = document.getElementById(pillId);
      try{
        const res = await fetch(url, {method:'GET', cache:'no-store'});
        if(res.ok){
          el.textContent = 'available';
          el.className = 'pill ok';
        }else{
          el.textContent = 'missing';
          el.className = 'pill warn';
        }
      }catch{
        el.textContent = 'missing';
        el.className = 'pill warn';
      }
    }

    loadExclusions();
    checkFile('./out/one_sheet_overall.html', 'chkOverall');
    checkFile('./out/one_sheet_peak.html', 'chkPeak');
  </script>
</body>
</html>